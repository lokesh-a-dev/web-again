<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Room</title>
</head>
<body>

<h2>Join Room</h2>
<input id="roomId" placeholder="Enter Room ID" />
<button onclick="joinRoom()">Join</button>

<div id="videos"></div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
const peers = {};
let localStream;

async function joinRoom() {

  const roomId = document.getElementById("roomId").value;
  if (!roomId) return alert("Enter Room ID");

  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });

  addVideo(localStream, "local");

  socket.emit("join-room", roomId);
}

socket.on("existing-users", users => {
  users.forEach(userId => createPeer(userId, true));
});

socket.on("new-user", userId => {
  createPeer(userId, true);
});

socket.on("offer", async ({ offer, from }) => {
  createPeer(from, false);
  await peers[from].setRemoteDescription(offer);
  const answer = await peers[from].createAnswer();
  await peers[from].setLocalDescription(answer);
  socket.emit("answer", { answer, to: from });
});

socket.on("answer", async ({ answer, from }) => {
  await peers[from].setRemoteDescription(answer);
});

socket.on("ice-candidate", async ({ candidate, from }) => {
  if (peers[from]) {
    await peers[from].addIceCandidate(candidate);
  }
});

socket.on("user-left", userId => {
  if (peers[userId]) {
    peers[userId].close();
    delete peers[userId];
    document.getElementById(userId)?.remove();
  }
});

function createPeer(userId, initiator) {

  if (peers[userId]) return;

  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  peers[userId] = pc;

  localStream.getTracks().forEach(track =>
    pc.addTrack(track, localStream)
  );

  pc.ontrack = event => {
    addVideo(event.streams[0], userId);
  };

  pc.onicecandidate = event => {
    if (event.candidate) {
      socket.emit("ice-candidate", {
        candidate: event.candidate,
        to: userId
      });
    }
  };

  if (initiator) {
    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      socket.emit("offer", { offer, to: userId });
    });
  }
}

function addVideo(stream, id) {
  if (document.getElementById(id)) return;

  const video = document.createElement("video");
  video.id = id;
  video.srcObject = stream;
  video.autoplay = true;
  video.playsInline = true;
  video.width = 250;

  document.getElementById("videos").appendChild(video);
}

</script>

</body>
</html>